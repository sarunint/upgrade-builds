{"version":3,"file":"upgrade_ng1_adapter.js","sourceRoot":"","sources":["../../../../../../packages/upgrade/src/dynamic/upgrade_ng1_adapter.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {Directive, DoCheck, ElementRef, EventEmitter, Inject, Injector, OnChanges, OnInit, SimpleChange, SimpleChanges, Type} from '@angular/core';\n\nimport * as angular from '../common/angular1';\nimport {$SCOPE} from '../common/constants';\nimport {IBindingDestination, IControllerInstance, UpgradeHelper} from '../common/upgrade_helper';\nimport {isFunction, strictEquals} from '../common/util';\n\n\nconst CAMEL_CASE = /([A-Z])/g;\nconst INITIAL_VALUE = {\n  __UNINITIALIZED__: true\n};\nconst NOT_SUPPORTED: any = 'NOT_SUPPORTED';\n\n\nexport class UpgradeNg1ComponentAdapterBuilder {\n  // TODO(issue/24571): remove '!'.\n  type !: Type<any>;\n  inputs: string[] = [];\n  inputsRename: string[] = [];\n  outputs: string[] = [];\n  outputsRename: string[] = [];\n  propertyOutputs: string[] = [];\n  checkProperties: string[] = [];\n  propertyMap: {[name: string]: string} = {};\n  directive: angular.IDirective|null = null;\n  // TODO(issue/24571): remove '!'.\n  template !: string;\n\n  constructor(public name: string) {\n    const selector =\n        name.replace(CAMEL_CASE, (all: string, next: string) => '-' + next.toLowerCase());\n    const self = this;\n\n    // Note: There is a bug in TS 2.4 that prevents us from\n    // inlining this into @Directive\n    // TODO(tbosch): find or file a bug against TypeScript for this.\n    const directive = {selector: selector, inputs: this.inputsRename, outputs: this.outputsRename};\n\n    @Directive({jit: true, ...directive})\n    class MyClass {\n      // TODO(issue/24571): remove '!'.\n      directive !: angular.IDirective;\n      constructor(\n          @Inject($SCOPE) scope: angular.IScope, injector: Injector, elementRef: ElementRef) {\n        const helper = new UpgradeHelper(injector, name, elementRef, this.directive);\n        return new UpgradeNg1ComponentAdapter(\n            helper, scope, self.template, self.inputs, self.outputs, self.propertyOutputs,\n            self.checkProperties, self.propertyMap) as any;\n      }\n      ngOnInit() { /* needs to be here for ng2 to properly detect it */\n      }\n      ngOnChanges() { /* needs to be here for ng2 to properly detect it */\n      }\n      ngDoCheck() { /* needs to be here for ng2 to properly detect it */\n      }\n      ngOnDestroy() { /* needs to be here for ng2 to properly detect it */\n      }\n    }\n    this.type = MyClass;\n  }\n\n  extractBindings() {\n    const btcIsObject = typeof this.directive !.bindToController === 'object';\n    if (btcIsObject && Object.keys(this.directive !.scope !).length) {\n      throw new Error(\n          `Binding definitions on scope and controller at the same time are not supported.`);\n    }\n\n    const context = (btcIsObject) ? this.directive !.bindToController : this.directive !.scope;\n\n    if (typeof context == 'object') {\n      Object.keys(context).forEach(propName => {\n        const definition = context[propName];\n        const bindingType = definition.charAt(0);\n        const bindingOptions = definition.charAt(1);\n        const attrName = definition.substring(bindingOptions === '?' ? 2 : 1) || propName;\n\n        // QUESTION: What about `=*`? Ignore? Throw? Support?\n\n        const inputName = `input_${attrName}`;\n        const inputNameRename = `${inputName}: ${attrName}`;\n        const outputName = `output_${attrName}`;\n        const outputNameRename = `${outputName}: ${attrName}`;\n        const outputNameRenameChange = `${outputNameRename}Change`;\n\n        switch (bindingType) {\n          case '@':\n          case '<':\n            this.inputs.push(inputName);\n            this.inputsRename.push(inputNameRename);\n            this.propertyMap[inputName] = propName;\n            break;\n          case '=':\n            this.inputs.push(inputName);\n            this.inputsRename.push(inputNameRename);\n            this.propertyMap[inputName] = propName;\n\n            this.outputs.push(outputName);\n            this.outputsRename.push(outputNameRenameChange);\n            this.propertyMap[outputName] = propName;\n\n            this.checkProperties.push(propName);\n            this.propertyOutputs.push(outputName);\n            break;\n          case '&':\n            this.outputs.push(outputName);\n            this.outputsRename.push(outputNameRename);\n            this.propertyMap[outputName] = propName;\n            break;\n          default:\n            let json = JSON.stringify(context);\n            throw new Error(\n                `Unexpected mapping '${bindingType}' in '${json}' in '${this.name}' directive.`);\n        }\n      });\n    }\n  }\n\n  /**\n   * Upgrade ng1 components into Angular.\n   */\n  static resolve(\n      exportedComponents: {[name: string]: UpgradeNg1ComponentAdapterBuilder},\n      $injector: angular.IInjectorService): Promise<string[]> {\n    const promises = Object.keys(exportedComponents).map(name => {\n      const exportedComponent = exportedComponents[name];\n      exportedComponent.directive = UpgradeHelper.getDirective($injector, name);\n      exportedComponent.extractBindings();\n\n      return Promise\n          .resolve(UpgradeHelper.getTemplate($injector, exportedComponent.directive, true))\n          .then(template => exportedComponent.template = template);\n    });\n\n    return Promise.all(promises);\n  }\n}\n\nclass UpgradeNg1ComponentAdapter implements OnInit, OnChanges, DoCheck {\n  private controllerInstance: IControllerInstance|null = null;\n  destinationObj: IBindingDestination|null = null;\n  checkLastValues: any[] = [];\n  private directive: angular.IDirective;\n  element: Element;\n  $element: any = null;\n  componentScope: angular.IScope;\n\n  constructor(\n      private helper: UpgradeHelper, scope: angular.IScope, private template: string,\n      private inputs: string[], private outputs: string[], private propOuts: string[],\n      private checkProperties: string[], private propertyMap: {[key: string]: string}) {\n    this.directive = helper.directive;\n    this.element = helper.element;\n    this.$element = helper.$element;\n    this.componentScope = scope.$new(!!this.directive.scope);\n\n    const controllerType = this.directive.controller;\n\n    if (this.directive.bindToController && controllerType) {\n      this.controllerInstance = this.helper.buildController(controllerType, this.componentScope);\n      this.destinationObj = this.controllerInstance;\n    } else {\n      this.destinationObj = this.componentScope;\n    }\n\n    for (let i = 0; i < inputs.length; i++) {\n      (this as any)[inputs[i]] = null;\n    }\n    for (let j = 0; j < outputs.length; j++) {\n      const emitter = (this as any)[outputs[j]] = new EventEmitter<any>();\n      if (this.propOuts.indexOf(outputs[j]) === -1) {\n        this.setComponentProperty(\n            outputs[j], (emitter => (value: any) => emitter.emit(value))(emitter));\n      }\n    }\n    for (let k = 0; k < propOuts.length; k++) {\n      this.checkLastValues.push(INITIAL_VALUE);\n    }\n  }\n\n  ngOnInit() {\n    // Collect contents, insert and compile template\n    const attachChildNodes: angular.ILinkFn|undefined = this.helper.prepareTransclusion();\n    const linkFn = this.helper.compileTemplate(this.template);\n\n    // Instantiate controller (if not already done so)\n    const controllerType = this.directive.controller;\n    const bindToController = this.directive.bindToController;\n    if (controllerType && !bindToController) {\n      this.controllerInstance = this.helper.buildController(controllerType, this.componentScope);\n    }\n\n    // Require other controllers\n    const requiredControllers =\n        this.helper.resolveAndBindRequiredControllers(this.controllerInstance);\n\n    // Hook: $onInit\n    if (this.controllerInstance && isFunction(this.controllerInstance.$onInit)) {\n      this.controllerInstance.$onInit();\n    }\n\n    // Linking\n    const link = this.directive.link;\n    const preLink = (typeof link == 'object') && (link as angular.IDirectivePrePost).pre;\n    const postLink = (typeof link == 'object') ? (link as angular.IDirectivePrePost).post : link;\n    const attrs: angular.IAttributes = NOT_SUPPORTED;\n    const transcludeFn: angular.ITranscludeFunction = NOT_SUPPORTED;\n    if (preLink) {\n      preLink(this.componentScope, this.$element, attrs, requiredControllers, transcludeFn);\n    }\n\n    linkFn(this.componentScope, null !, {parentBoundTranscludeFn: attachChildNodes});\n\n    if (postLink) {\n      postLink(this.componentScope, this.$element, attrs, requiredControllers, transcludeFn);\n    }\n\n    // Hook: $postLink\n    if (this.controllerInstance && isFunction(this.controllerInstance.$postLink)) {\n      this.controllerInstance.$postLink();\n    }\n  }\n\n  ngOnChanges(changes: SimpleChanges) {\n    const ng1Changes: any = {};\n    Object.keys(changes).forEach(name => {\n      const change: SimpleChange = changes[name];\n      this.setComponentProperty(name, change.currentValue);\n      ng1Changes[this.propertyMap[name]] = change;\n    });\n\n    if (isFunction(this.destinationObj !.$onChanges)) {\n      this.destinationObj !.$onChanges !(ng1Changes);\n    }\n  }\n\n  ngDoCheck() {\n    const destinationObj = this.destinationObj;\n    const lastValues = this.checkLastValues;\n    const checkProperties = this.checkProperties;\n    const propOuts = this.propOuts;\n    checkProperties.forEach((propName, i) => {\n      const value = destinationObj ![propName];\n      const last = lastValues[i];\n      if (!strictEquals(last, value)) {\n        const eventEmitter: EventEmitter<any> = (this as any)[propOuts[i]];\n        eventEmitter.emit(lastValues[i] = value);\n      }\n    });\n\n    if (this.controllerInstance && isFunction(this.controllerInstance.$doCheck)) {\n      this.controllerInstance.$doCheck();\n    }\n  }\n\n  ngOnDestroy() { this.helper.onDestroy(this.componentScope, this.controllerInstance); }\n\n  setComponentProperty(name: string, value: any) {\n    this.destinationObj ![this.propertyMap[name]] = value;\n  }\n}\n"]}